define("js/app/controller/BuyCgM",["js/app/controller/base","js/app/util/ajax","js/app/module/loading/loading"],function(e,n,t){function i(){c(),t.createLoading(),$.when(d(),a()).then(t.hideLoading,t.hideLoading)}function a(){return o("CNY","CGB")}function o(e,t){return n.get("002051",{fromCurrency:e,toCurrency:t}).then(function(e){m=e.data.rate})}function d(){return n.get("802503",{userId:e.getUserId()}).then(function(n){if(n.success){var t=n.data;t.forEach(function(n){"CNY"==n.currency?$("#reamin").html("¥"+e.formatMoney(n.amount)):"CGB"==n.currency&&$("#caigoRemain").html(e.formatMoney(n.amount)+" , 1人民币兑换"+m+"菜狗币")})}})}function c(){$("#content").on("click",".pay-item",function(){var e=$(this),n=e.index();e.siblings(".active").removeClass("active"),e.addClass("active"),h=n}),$("#cgbAmount").on("keyup",function(){var n=$(this),t=n.val();$.isNumeric(t)?(f=1e3*t,$("#needAmount").val(e.formatMoney(f/m))):(f=0,$("#needAmount").val(0))}),$("#sbtn").click(function(){var n=$("#cgbAmount").val();0==h?s(1):/^[1-9]\d*$/.test(n)?r(5):e.showMsg("购买数量只能为整数")})}function r(i){t.createLoading("支付中..."),n.post("802420",{json:{fromUserId:e.getUserId(),toUserId:SYSTEM_USERID,amount:f,payType:i,currency:"CGB"}}).then(function(n){n.success?(t.hideLoading(),g(n.data)):(t.hideLoading(),e.showMsg(n.msg))})}function s(i){t.createLoading("支付中..."),n.post("802420",{json:{fromUserId:e.getUserId(),toUserId:SYSTEM_USERID,amount:f,payType:i,currency:"CGB"}}).then(function(n){n.success?1==i?(t.hideLoading(),e.showMsg("支付成功"),setTimeout(function(){e.getBack()},1e3)):(t.hideLoading(),g(n.data)):(t.hideLoading(),e.showMsg(n.msg))})}function u(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:p.appId,timeStamp:p.timeStamp,nonceStr:p.nonceStr,"package":p.wechatPackage,signType:p.signType,paySign:p.paySign},function(n){t.hideLoading(),"get_brand_wcpay_request:ok"==n.err_msg?(e.showMsg("支付成功"),setTimeout(function(){e.getBack()},1e3)):e.showMsg("支付失败")})}function g(n){p=n,n&&n.signType?"undefined"==typeof WeixinJSBridge?document.addEventListener?(document.removeEventListener("WeixinJSBridgeReady",u),document.addEventListener("WeixinJSBridgeReady",u,!1)):document.attachEvent&&(document.detachEvent("WeixinJSBridgeReady",u),document.detachEvent("onWeixinJSBridgeReady",u),document.attachEvent("WeixinJSBridgeReady",u),document.attachEvent("onWeixinJSBridgeReady",u)):u():(t.hideLoading(),e.showMsg(n.msg||"微信支付失败"))}var m=1,h=0,f=0;i();var p={}});