define("js/app/controller/Consume",["js/app/controller/base","js/app/util/ajax","js/app/util/dialog","js/app/module/loadImg/loadImg","js/app/module/loading/loading"],function(t,e,i,n,s){$(function(){function o(){I=sessionStorage.getItem("province")||"",w=sessionStorage.getItem("city")||"",I?(w=w||I,a()):t.getInitLocation(function(){I=sessionStorage.getItem("province"),w=sessionStorage.getItem("city"),s.hideLoading(),a()},function(){s.hideLoading(),a(),t.showMsg("定位失败",1e3)}),r()}function a(){s.hideLoading(),y(),l(),t.getAddress().then(function(t){citylist=t.citylist;var e="";$.each(citylist,function(t,i){i.c&&i.c[0].a?$.each(i.c,function(n,s){U.push(s.n),s.n==w||-1!=w.indexOf(s.n)||-1!=s.n.indexOf(w)?(e+='<li class="cityn on" prov="'+t+'" city="'+n+'">'+s.n+"</li>",$("#nowDiv").html('<input type="button" class="btn" style="width:auto;padding:0 10px;" id="nowCity" prov="'+t+'" city="'+n+'" value="'+s.n+'"/>'),k.province=i.p,k.city=s.n,$("#city").find("span").text(s.n),sessionStorage.setItem("province",i.p),sessionStorage.setItem("city",s.n),h()):e+='<li class="cityn" prov="'+t+'" city="'+n+'">'+s.n+"</li>"}):(U.push(i.p),i.p==I||-1!=I.indexOf(i.p)||-1!=i.p.indexOf(I)?($("#nowDiv").html('<input type="button" class="btn" id="nowCity" prov="'+t+'" value="'+i.p+'"/>'),e+='<li class="cityn on" prov="'+t+'">'+i.p+"</li>",k.province=i.p,k.city="",sessionStorage.setItem("province",i.p),sessionStorage.setItem("city",""),$("#city").find("span").text(k.province),h()):e+='<li class="cityn" prov="'+t+'">'+i.p+"</li>")}),$("#consumeUl").html(e),k.province=sessionStorage.getItem("province"),k.city=sessionStorage.getItem("city"),k.area=sessionStorage.getItem("area"),I?"":(C(),_())})}function c(){e.get("804040",{pushType:41,toKind:1,channelType:4,status:1,start:1,limit:1,fromSystemCode:SYSTEM_CODE}).then(function(t){t.success&&t.data.list.length&&$(".noticeCon p").text(t.data.list[0].smsTitle)})}function l(){$("#con-table").html('<i class="icon-loading3"></i>');var i={parentCode:"0",status:"1",orderColumn:"order_no",orderDir:"asc",type:"2"};e.get("808007",i).then(function(e){if(e.success&&e.data.length){for(var i=0,n="";i<e.data.length;i++)n+='<li><a href="javascript:void(0)" l_type="'+e.data[i].code+'"><div><img src="'+t.getImg(e.data[i].pic)+'" alt=""></div><p>'+e.data[i].name+"</p></a></li>";var s=$(n),o=s.find("img"),a=o.length;O=a;for(var i=0;a>i;i++){var c=o.eq(i);c[0].complete?d():!function(t){t[0].onload=function(){d()}}(c)}$("#con-table").empty().append(s)}else $("#con-table").html('<tr style="line-height: 140px;"><td>暂无分类信息</td></tr>')},function(){$("#con-table").html('<tr style="line-height: 140px;"><td>暂无分类信息</td></tr>')})}function d(){if(!--O){var t=$("#conTop")[0].offsetHeight+$("#tableWrap")[0].offsetHeight;$("#marginTop").css("height",t)}}function r(){$("#consume-ul").on("click",".good-div",function(e){var i=$(this),n=i.find("img");return e.preventDefault(),e.stopPropagation(),t.isLogin()?void(-1!=n.attr("src").indexOf("/good.png")?g(this,n):g(this,n,!0)):void t.goLogin()}),$(window).on("scroll",function(){$(this);T&&!S&&$(document).height()-$(window).height()-10<=$(document).scrollTop()&&$("#mask").hasClass("hidden")&&(T=!1,y(),h())}),function(){function t(){var t=$("#searchInput").val();t&&""!==t.trim()?t!=e&&(u($("#searchInput")[0]),e=t):($("#searchUl").addClass("hidden").empty(),e="")}var e="";$("#searchInput").on("focus",function(){var e=setInterval(t,150);$(this).on("blur",function(){clearInterval(e)}),m()})}(),$("#city").on("click",function(){$("#consumeDiv").hasClass("hidden")?($("#noResult").addClass("hidden"),$("#mask, #consumeDiv").removeClass("hidden")):$("#mask, #consumeDiv").addClass("hidden")}),$("#consumeUl").on("click","li.cityn",function(){var t=$(this),e=t.text(),i=t.attr("prov"),n=t.attr("city");$("#consumeUl").find("li.on").removeClass("on"),t.addClass("on"),k.province=citylist[i].p,k.city=n&&citylist[i].c[n].n||"",k.area="",k.start=1,sessionStorage.setItem("province",k.province),sessionStorage.setItem("city",k.city),sessionStorage.setItem("area",""),$("#nowCity").val(e),$("#city").find("span").text(e),p()}),$("#mask").on("click",function(){m()}),$("#searchCity").on("click",function(){var t=$("#cityInput").val().trim(),e=!1;if(t){$("#sResult").addClass("hidden");for(var i=0;i<U.length;i++)if(-1!=U[i].indexOf(t)){{var n=$("#consumeUl").find("li:eq("+i+")");n.attr("prov"),n.attr("city")}$("#sResult").removeClass("hidden").html('<input class="btn" type="button" value="'+U[i]+'" indx="'+i+'"/>'),e=!0;break}e?$("#noResult").addClass("hidden"):($("#sResult").addClass("hidden"),$("#noResult").removeClass("hidden"))}}),$("#con-table").on("click","a",function(){var t=$(this).attr("l_type"),e=$("#consumeUl").find("li.on"),i="";i=-1==location.pathname.indexOf("/consume/")?"consume/list.html?t="+t+"&p="+e.attr("prov"):"./list.html?t="+t+"&p="+e.attr("prov");var n=e.attr("city");n&&(i+="&c="+e.attr("city")||""),location.href=i}),$("#sResult").on("click","input",function(){var t=$(this).attr("indx"),e=$("#consumeUl"),i=e.find("li:eq("+t+")");i.click(),$("#sResult").addClass("hidden")})}function p(){T=!1,S=!1,D=!0,$("#consume-ul").empty(),y(),h(),m()}function m(){$("#mask, #consumeDiv").addClass("hidden")}function u(t){var i={province:k.province,city:k.city,area:k.area,name:t.value,limit:10,start:1,orderDir:"desc",orderColumn:"total_dz_num"};e.get(x,i).then(function(t){if(t.success){var e="",i=t.data.list;i.length?(i.forEach(function(t){e+=-1==location.pathname.indexOf("/consume/")?'<li><a class="show" href="consume/detail.html?c='+t.code+'">'+t.name+"</a></li>":'<li><a class="show" href="./detail.html?c='+t.code+'">'+t.name+"</a></li>"}),$("#searchUl").removeClass("hidden").html(e)):$("#searchUl").empty().addClass("hidden")}})}function g(i,n,s){var o=$(i),a=o.closest("li[code]").attr("code"),c=o.find("span");$("#loaddingIcon1").removeClass("hidden"),e.post("808240",{json:{storeCode:a,type:1,userId:t.getUserId()}}).then(function(t){$("#loaddingIcon1").addClass("hidden"),t.success?s?(c.text(+c.text()-1),n.attr("src","/static/images/good.png")):(c.text(+c.text()+1),n.attr("src","/static/images/good1.png")):t.timeout?location.href="../user/login.html?return="+encodeURIComponent(location.pathname+location.search):b(t.msg)})}function h(){k.isDefault="",e.get(x,k).then(function(e){if(e.success)if(e.data.list.length){var i=e.data,s=+i.totalCount,o=i.list;if((s<=k.limit||o.length<k.limit)&&(S=!0),o.length){for(var a="",c=0;c<o.length;c++)a+='<li class="ptb8 clearfix b_bd_b plr10" code="'+o[c].code+'"><a class="show p_r min-h100p" ',a+=-1==location.pathname.indexOf("/consume/")?'href="consume/detail.html?c='+o[c].code+'">':'href="./detail.html?c='+o[c].code+'">',a+='<div class="consume-center-wrap default-bg"><img class="center-img1 center-lazy" src="'+t.getImg(o[c].advPic,1)+'"/></div><div class="consume-right-wrap"><p class="tl line-tow t_bold">'+o[c].name+'</p><p class="tl pt4 line-tow s_10 t_80">'+o[c].slogan+"</p>",a+=o[c].province==o[c].city?'<p class="tl pt4 line-tow s_10 t_80">'+o[c].province+" "+o[c].area+" "+o[c].address+'</p></div><div class="good-div">':'<p class="tl pt4 line-tow s_10 t_80">'+o[c].province+" "+o[c].city+" "+o[c].address+'</p></div><div class="good-div">',a+=o[c].isDZ?'<img src="/static/images/good1.png"/><span class="inline_block va-m pl6 t_80">'+o[c].totalDzNum+"</span>":'<img src="/static/images/good.png"/><span class="inline_block va-m pl6 t_80">'+o[c].totalDzNum+"</span>",a+="</div></a></li>";$("#consume-ul").append(n.loadImg(a)),C(),k.start+=1}else v()}else f();else v();if(D&&$("#con-table").find("img").length){var l=$("#conTop")[0].offsetHeight+$("#tableWrap")[0].offsetHeight;$("#marginTop").css("height",l)}D=!1,T=!0})}function f(){k.isDefault=1,k.province="",k.city="",k.area="",e.get(x,k).then(function(e){if(e.success){var i=e.data,s=+i.totalCount,o=i.list;if((s<=k.limit||o.length<k.limit)&&(S=!0),o.length){for(var a="",c=0;c<o.length;c++)a+='<li class="ptb8 clearfix b_bd_b plr10" code="'+o[c].code+'"><a class="show p_r min-h100p" ',a+=-1==location.pathname.indexOf("/consume/")?'href="consume/detail.html?c='+o[c].code+'">':'href="./detail.html?c='+o[c].code+'">',a+='<div class="consume-center-wrap default-bg"><img class="center-img1 center-lazy" src="'+t.getImg(o[c].advPic,1)+'"/></div><div class="consume-right-wrap"><p class="tl line-tow t_bold">'+o[c].name+'</p><p class="tl pt4 line-tow s_10 t_80">'+o[c].slogan+"</p>",a+=o[c].province==o[c].city?'<p class="tl pt4 line-tow s_10 t_80">'+o[c].province+" "+o[c].area+" "+o[c].address+'</p></div><div class="good-div">':'<p class="tl pt4 line-tow s_10 t_80">'+o[c].province+" "+o[c].city+" "+o[c].address+'</p></div><div class="good-div">',a+=o[c].isDZ?'<img src="/static/images/good1.png"/><span class="inline_block va-m pl6 t_80">'+o[c].totalDzNum+"</span>":'<img src="/static/images/good.png"/><span class="inline_block va-m pl6 t_80">'+o[c].totalDzNum+"</span>",a+="</div></a></li>";$("#consume-ul").append(n.loadImg(a)),C(),k.start+=1}else v()}else v();if(D&&$("#con-table").find("img").length){var l=$("#conTop")[0].offsetHeight+$("#tableWrap")[0].offsetHeight;$("#marginTop").css("height",l)}D=!1,T=!0})}function v(){D?_():C()}function y(){$("#consume-ul").append('<li class="scroll-loadding"></li>')}function C(){$("#consume-ul").find(".scroll-loadding").remove()}function _(){$("#consume-ul").html('<li style="text-align: center;line-height: 93px;">暂时无法获取商家信息</li>')}function b(t,e){var n=i({content:t,quickClose:!0});n.show(),setTimeout(function(){n.close().remove()},e||2e3)}var I,w,x="808217",k={province:"",city:"",area:"",limit:10,start:1,orderDir:"desc",orderColumn:"total_dz_num",status:"2",userId:t.getUserId()},D=!0,S=!1,T=!1,U=[];$.when(o(),c());var O=1})});