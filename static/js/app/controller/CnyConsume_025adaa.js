define("js/app/controller/CnyConsume",["js/app/controller/base","js/app/util/ajax","js/app/module/loading/loading"],function(e,n,t){function o(){m(),f?(t.createLoading(),$("#name").text(l),$.when(a(),i()).then(t.hideLoading,t.hideLoading)):e.showMsg("未传入订单编号!")}function a(){return n.get("802503",{userId:e.getUserId()}).then(function(n){if(n.success){var t=n.data;t.forEach(function(n){"CNY"==n.currency?(p=+n.amount,$("#rmbRemain").html("¥"+e.formatMoneyD(n.amount))):"CGJF"==n.currency&&(M=+n.amount,$("#jfRemain").html(e.formatMoneyD(n.amount)))})}})}function i(){return r("CNY","CGJF")}function r(e,t){return n.get("002051",{fromCurrency:e,toCurrency:t}).then(function(e){v=e.data.rate})}function m(){$("#content").on("click",".pay-item",function(){var e=$(this),n=e.index();e.siblings(".active").removeClass("active"),e.addClass("active"),h=n}),$("#rmbAmount").on("keyup",function(){var n=$(this),t=n.val();if($.isNumeric(t))if(/^\d+(\.\d{1,2})?$/.test(t)){var o=1e3*t,a=1e3*t-1e3*e.formatMoney(o);g=1e3*t,$("#jfAmount").val(e.formatMoneyD(a)),$("#needAmount").val(e.formatMoney(o)),$("#totalAmount").html(e.formatMoney(o))}else e.showMsg("小数点后最多两位");else g=0,y=0,$("#TreatAmount").val(0),$("#jfAmount").val(0),$("#needAmount").val(0),$("#totalAmount").html(0)}),$("#TreatAmount").on("keyup",function(){var n=$(this),t=n.val(),o=$("#rmbAmount").val();if($.isNumeric(t))if(/^\d+(\.\d{1,2})?$/.test(t)){var a=1e3*t*(1-s)+1e3*(o-t),i=1e3*o-1e3*e.formatMoney(a);if(y=1e3*t,g=1e3*o,$("#jfAmount").val(e.formatMoneyD(i)),$("#needAmount").val(e.formatMoney(a)),i>M){var r=i-M,m=r/v;$("#totalAmount").html(e.formatMoney(m+a))}else $("#totalAmount").html(e.formatMoney(a))}else e.showMsg("小数点后最多两位");else{var a=1e3*o,i=1e3*o-1e3*e.formatMoney(a);g=1e3*o,y=0,$("#jfAmount").val(e.formatMoneyD(i)),$("#needAmount").val(e.formatMoney(a)),$("#totalAmount").html(e.formatMoney(a))}}),$("#sbtn").click(function(){$("#rmbAmount").val()?/^\d+(\.\d{1,2})?$/.test($("#rmbAmount").val())?c(0==h?21:5):e.showMsg("小数点后最多两位"):e.showMsg("请输入消费金额")})}function c(o){t.createLoading("支付中..."),n.post("808243",{json:{storeCode:f,userId:e.getUserId(),amount:g,disPrice:y,payType:o,isOnlyRmb:0}}).then(function(n){n.success?(t.hideLoading(),21==o?e.confirm("支付成功,是否返回商家详情").then(function(){location.href="../consume/detail.html?c="+f},function(){}):d(n.data)):(t.hideLoading(),"抵金券不足"==n.msg?e.confirm("抵金券余额不足，是否前往兑换？","否","是").then(function(){location.href="../user/buyIntegral.html"},function(){location.href="../consume/detail.html?c="+f}):"人民币不足"==n.msg?e.confirm("账户余额不足，是否前往充值？","否","是").then(function(){location.href="../pay/cny_recharge.html"},function(){e.confirm("支付成功,是否返回商家详情").then(function(){location.href="../consume/detail.html?c="+f},function(){})}):e.showMsg(n.msg))})}function u(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:A.appId,timeStamp:A.timeStamp,nonceStr:A.nonceStr,"package":A.wechatPackage,signType:A.signType,paySign:A.paySign},function(n){t.hideLoading(),"get_brand_wcpay_request:ok"==n.err_msg?e.confirm("支付成功,是否返回商家详情").then(function(){location.href="../consume/detail.html?c="+f},function(){}):e.showMsg("支付失败")})}function d(n){A=n,n&&n.signType?"undefined"==typeof WeixinJSBridge?document.addEventListener?(document.removeEventListener("WeixinJSBridgeReady",u),document.addEventListener("WeixinJSBridgeReady",u,!1)):document.attachEvent&&(document.detachEvent("WeixinJSBridgeReady",u),document.detachEvent("onWeixinJSBridgeReady",u),document.attachEvent("WeixinJSBridgeReady",u),document.attachEvent("onWeixinJSBridgeReady",u)):u():(t.hideLoading(),e.showMsg(n.msg||"微信支付失败"))}var s=e.getUrlParam("rate"),f=e.getUrlParam("c"),l=e.getUrlParam("n"),h=0,g=0,y=0,v=1,p=0,M=0;o();var A={}});