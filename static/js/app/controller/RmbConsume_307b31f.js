define("js/app/controller/RmbConsume",["js/app/controller/base","js/app/util/ajax","js/app/module/loading/loading"],function(e,n,t){function a(){i(),s?(t.createLoading(),$("#name").text(f),m&&"0"!=m&&$("#fxCGB-wrap").removeClass("hidden"),u&&"0"!=u&&$("#fxJF-wrap").removeClass("hidden"),$.when(o()).then(t.hideLoading,t.hideLoading)):e.showMsg("未传入订单编号!")}function o(){return n.get("802503",{userId:e.getUserId()}).then(function(n){if(n.success){var t=n.data;t.forEach(function(n){"CNY"==n.currency&&(h=+n.amount,$("#rmbRemain").html("¥"+e.formatMoneyD(n.amount)))})}})}function i(){$("#content").on("click",".pay-item",function(){var e=$(this),n=e.index();e.siblings(".active").removeClass("active"),e.addClass("active"),g=n}),$("#rmbAmount").on("keyup",function(){var n=$(this),t=n.val();if($.isNumeric(t))if(/^\d+(\.\d{1,2})?$/.test(t)){var a=1e3*t,o=a*m,i=a*u;$("#fxCGB").val(e.formatMoney(o)),$("#fxJF").val(e.formatMoney(i)),$("#needAmount").val(e.formatMoney(a)),l=1e3*t,$("#totalAmount").html(e.formatMoney(a))}else e.showMsg("小数点后最多两位");else l=0,$("#jfAmount").val(0),$("#needAmount").val(0),$("#totalAmount").html(0)}),$("#sbtn").click(function(){$("#rmbAmount").val()?/^\d+(\.\d{1,2})?$/.test($("#rmbAmount").val())?c(0==g?21:5):e.showMsg("小数点后最多两位"):e.showMsg("请输入消费金额")})}function c(a){t.createLoading("支付中..."),n.post("808243",{json:{storeCode:s,userId:e.getUserId(),amount:l,payType:a,isOnlyRmb:1}}).then(function(n){n.success?(t.hideLoading(),21==a?e.confirm("支付成功,是否返回商家详情").then(function(){location.href="../consume/detail.html?c="+s},function(){}):d(n.data)):(t.hideLoading(),"账户余额不足"==n.msg?e.confirm("账户余额不足，是否前往充值？","否","是").then(function(){location.href="../pay/cny_recharge.html"},function(){e.confirm("支付成功,是否返回商家详情").then(function(){location.href="../consume/detail.html?c="+s},function(){})}):e.showMsg(n.msg))})}function r(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:p.appId,timeStamp:p.timeStamp,nonceStr:p.nonceStr,"package":p.wechatPackage,signType:p.signType,paySign:p.paySign},function(n){t.hideLoading(),"get_brand_wcpay_request:ok"==n.err_msg?e.confirm("支付成功,是否返回商家详情").then(function(){location.href="../consume/detail.html?c="+s},function(){}):e.showMsg("支付失败")})}function d(n){p=n,n&&n.signType?"undefined"==typeof WeixinJSBridge?document.addEventListener?(document.removeEventListener("WeixinJSBridgeReady",r),document.addEventListener("WeixinJSBridgeReady",r,!1)):document.attachEvent&&(document.detachEvent("WeixinJSBridgeReady",r),document.detachEvent("onWeixinJSBridgeReady",r),document.attachEvent("WeixinJSBridgeReady",r),document.attachEvent("onWeixinJSBridgeReady",r)):r():(t.hideLoading(),e.showMsg(n.msg||"微信支付失败"))}var s=e.getUrlParam("c"),m=e.getUrlParam("rate"),u=e.getUrlParam("rate4"),f=e.getUrlParam("n"),g=0,l=0,h=0;a();var p={}});