define("js/app/controller/Cart",["js/app/controller/base","js/app/util/ajax","js/app/util/dialog","js/lib/handlebars.runtime-v3.0.3","js/app/module/loadImg/loadImg"],function(t,a,e,o,n){$(function(){function o(){i(),s()}function i(){v=[],param={userId:f},a.post("808047",{json:param}).then(function(a){if(a.success){var e=a.data,o="";if(e.length){o='<ul class="b_bd_b bg_fff">',e.forEach(function(a){var e=0,n=0;a.product.price2&&+a.product.price2&&(e=+a.product.price2*+a.quantity,$("#totalAmount").parent().removeClass("hidden")),a.product.price3&&+a.product.price3&&(n=+a.product.price3*+a.quantity,$("#jfSpan, #mAdd").removeClass("hidden")),o+='<li class="ptb8 plr10 clearfix b_bd_b p_r" code="'+a.code+'" saleP="'+a.product.price2+'" cnyP="'+(a.product.price3||0)+'"><div class="wp100 p_r z_index0 over-hide"><div class="clearfix bg_fff cart-content-left">',o+="2"==a.status?'<div class="cart-down t_999">已下架</div><div class="fl wp40 tc pl32 p_r c-img-l"><div class="cart-cont-left"><div class="radio-tip1 ab_l0"><i></i></div></div><a class="cart-center-img-a" href="javascript:void(0)">':'<div class="fl wp40 tc pl32 p_r c-img-l overhide"><div class="cart-cont-left"><div class="radio-tip1 ab_l0"><i></i></div></div><a class="cart-center-img-a" href="../operator/buy.html?code='+a.productCode+'">',o+='<img class="center-img1" src="'+t.getImg(a.product.advPic)+'"/></a></div><div class="fl wp60 pl12"><p class="t_323232 s_12 line-tow">'+a.product.name+'</p><p class="t_f64444 s_12">',a.product.price2&&a.product.price3?o+="<span>"+t.formatMoneyD(a.product.price2)+'</span><span class="t_40pe s_10">菜狗币</span><span>+'+t.formatMoneyD(a.product.price3)+'</span><span class="t_40pe s_10">抵金券</span>':a.product.price2&&!a.product.price3?o+="<span>"+t.formatMoneyD(a.product.price2)+'</span><span class="t_40pe s_10">菜狗币</span>':!a.product.price2&&a.product.price3&&(o+="<span>"+t.formatMoneyD(a.product.price3)+'</span><span class="t_40pe s_10">抵金券</span>'),o+='</p><div class="t_666 ptb10"><span class="subCount a_s_span t_bold tc"><img src="/static/images/sub-icon.png" style="width: 20px;"/></span><input type="hidden" value="'+ +a.quantity+'"/><input class="buyCount tc w60p s_13 lh32" type="text" value="'+a.quantity+'"/><span class="addCount a_s_span t_bold tc"><img src="/static/images/add-icon.png" style="width: 20px;"/></span></div></div></div><div class="al_addr_del">删除</div></div></li>',v.push([e,n])}),o+="</ul>",$("#od-ul").html(n.loadImg(o)),$("#totalAmount").html("0").data("price",0),$("#totalCnyAmount").html("0").data("price",0)}else l()}else l()})}function s(){$("#sbtn").on("click",function(){for(var t=[],a=$("#od-ul>ul>li div.c-img-l div.radio-tip1"),e=0;e<a.length;e++){var o=a[e];if($(o).hasClass("active")){if($(o).closest("li[code]").find("div.cart-down").length)return void c("您所选择的商品中包含已经下架的商品，<br/>请重新选择！",3e3);t.push(e)}}t.length?location.href="../operator/submit_order.html?code="+t.join("_")+"&type=2":c("未选择购买的商品")}),$("#od-ul").on("click",".subCount",function(t){t.stopPropagation();var a=$(this).next().next(),e=a.val();(void 0==e||""==e||"0"==e||"1"==e)&&(e=2),e=+e-1,a.val(e),a.change()}),$("#od-ul").on("click",".addCount",function(t){t.stopPropagation();var a=$(this).prev(),e=a.val();(void 0==e||""==e)&&(e=0),e=+e+1,a.val(e),a.change()}),$("#od-ul").on("keyup","input",function(t){t.stopPropagation();var a=t.charCode||t.keyCode,e=$(this);p(a)||d(a)||e.val(e.val().replace(/[^\d]/g,"")),e.val()||e.change()}),$("#od-ul").on("change","input[type=text]",function(e){e.stopPropagation();var o=e.charCode||e.keyCode,n=$(this);p(o)||n.val(n.val().replace(/[^\d]/g,"")),n.val()||n.val("1"),"0"==n.val()&&n.val("1");var i=$(this).parents("li[code]"),s=+i.attr("saleP"),l=+i.attr("cnyP"),d={code:i.attr("code"),quantity:this.value};$("#loaddingIcon").removeClass("hidden"),n=this,a.post("808042",{json:d}).then(function(a){if($("#loaddingIcon").addClass("hidden"),a.success){var e=i.find(".c-img-l .radio-tip1.active").length,o=$(n).prev(),d=n.value,r=s,p=l,u=r*+d,f=p*+d,m=v[i.index()],h=m[0],g=m[1],x=+$("#totalAmount").data("price"),C=+$("#totalCnyAmount").data("price"),y=u-h+x;new_cnyTotal=f-g+C,v[i.index()]=[u,f],o.val(d),e&&($("#totalAmount").text(t.formatMoneyD(y)).data("price",y),$("#totalCnyAmount").text(t.formatMoneyD(new_cnyTotal)).data("price",new_cnyTotal))}else n.value=$(n).prev().val(),c("数量修改失败，请重试！")})}),$("#allChecked").on("click",function(){var a=!1,e=$(this),o="removeClass";if(e.hasClass("active")?e.removeClass("active"):(e.addClass("active"),a=!0,o="addClass"),$("#od-ul>ul>li div.c-img-l div.radio-tip1").each(function(t,a){$(a)[o]("active")}),a){for(var n=0,i=0,s=0;s<v.length;s++)n+=v[s][0],i+=v[s][1];$("#totalAmount").text(t.formatMoneyD(n)).data("price",n),$("#totalCnyAmount").text(t.formatMoneyD(i)).data("price",i)}else $("#totalAmount").text("0").data("price",0),$("#totalCnyAmount").text("0").data("price",0)}),$("#od-ul").on("click","li[code] .cart-cont-left",function(a){a.stopPropagation();var e=$(this).closest("li[code]"),o=!1,n=$(this).find(".radio-tip1");if(n.hasClass("active")?n.removeClass("active"):(n.addClass("active"),o=!0),o){$("#od-ul>ul>li").length==$("#od-ul>ul>li .c-img-l div.active").length&&$("#allChecked").addClass("active");var i=+$("#totalAmount").data("price"),s=+$("#totalCnyAmount").data("price"),c=i+v[e.index()][0],l=s+v[e.index()][1];$("#totalAmount").text(t.formatMoneyD(c)).data("price",c),$("#totalCnyAmount").text(t.formatMoneyD(l)).data("price",l)}else{{$("#od-ul").children("li").find("input[type=checkbox]")}$("#allChecked").removeClass("active");var i=+$("#totalAmount").data("price"),s=+$("#totalCnyAmount").data("price"),c=i-v[e.index()][0],l=s-v[e.index()][1];$("#totalAmount").text(t.formatMoneyD(c)).data("price",c),$("#totalCnyAmount").text(t.formatMoneyD(l)).data("price",c)}}),$("#odOk").on("click",function(){r(u),$("#od-mask, #od-tipbox").addClass("hidden")}),$("#odCel").on("click",function(){$("#od-mask, #od-tipbox").addClass("hidden")}),$("#od-ul").on("touchstart",".cart-content-left",function(t){t.stopPropagation();var a=t.originalEvent.targetTouches[0],e=$(this),o=e.offset().left;e.data("x",a.clientX),e.data("offsetLeft",o)}),$("#od-ul").on("touchmove",".cart-content-left",function(t){t.stopPropagation();var a=t.originalEvent.changedTouches[0],e=$(this),o=a.clientX,n=parseInt(e.data("x"))-o,i=e.data("offsetLeft");if(n>10)e.css({transition:"none",transform:"translate3d("+-n/2+"px, 0px, 0px)"});else if(-10>n){var i=e.data("offsetLeft");e.css({transition:"none",transform:"translate3d("+(i+-n/2)+"px, 0px, 0px)"})}}),$("#od-ul").on("touchend",".cart-content-left",function(t){t.stopPropagation();var a=$(this),e=t.originalEvent.changedTouches[0],o=e.clientX,n=parseInt(a.data("x"))-o;a.css(n>56?{transition:"-webkit-transform 0.2s ease-in",transform:"translate3d(-56px, 0px, 0px)"}:{transition:"-webkit-transform 0.2s ease-in",transform:"translate3d(0px, 0px, 0px)"})}),$("#od-ul").on("click",".al_addr_del",function(t){t.stopPropagation(),u=this,$("#od-mask, #od-tipbox").removeClass("hidden")})}function c(t,a){var o=e({content:t,quickClose:!0});o.show(),setTimeout(function(){o.close().remove()},a||2e3)}function l(){$("#cart-bottom").hide(),$("#od-ul").empty(),$("#noItem").removeClass("hidden")}function d(t){return t>=48&&57>=t||t>=96&&105>=t?!0:!1}function r(t){var e=$(t).closest("li[code]"),o=e.attr("code");$("#loaddingIcon").removeClass("hidden"),param3={cartCodeList:[o]},a.post("808041",{json:param3}).then(function(a){if($("#loaddingIcon").addClass("hidden"),a.success){var o=$(t).prev().find(".cart-cont-left"),n=o.find(".radio-tip1.active");n.length&&n.click(),v.splice(e.index(),1),e.remove(),$("#od-ul>ul>li").length||($("#cart-bottom").hide(),$("#od-ul").html('<div class="bg_fff" style="text-align: center;line-height: 150px;">购物车内暂无商品</div>'))}else c("删除失败，请重试！")})}function p(t){return 37==t||39==t||8==t||46==t?!0:!1}var u,v=[],f=sessionStorage.getItem("userId");"1"==sessionStorage.getItem("user")&&o()})});